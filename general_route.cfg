route{
	$var(from_proxy) = ds_is_in_list("$si", "$sp");			#Ищем есть ли адрес/порт в списке
	$var(nolog) = 0;
	if ( ($var(from_proxy) == 1) && (is_method("OPTIONS")) ) {
		$var(nolog) = 1;
	}
	if ($var(nolog) == 0) {
		xlog("L_INFO", "[MAIN] Incoming request (M=$rm IP=$si:$sp RURI=$ru DURI=$du F=$fu T=$tu oP=$oP pr=$pr dP=$dP rP=$rP ID=$ci cseq=$cs UA=$ua)n$mb");
	}
	
	force_rport();			#Добавляем rport
	remove_hf("Path");		#Удаляем заголовок Path
	route(VALIDATE);
	route(PING);
	
	if (is_method("REGISTER")) {
		if (!add_path_received()) { 	# Добавление заголовка path с указанием from ip 
			xlog("L_ERR", "[MAIN] Cannot add path (M=$rm IP=$si:$sp RURI=$ru DURI=$du F=$fu T=$tu oP=$oP pr=$pr dP=$dP rP=$rP ID=$ci cseq=$cs UA=$ua)n");
			send_reply("503", "Internal Path Error");
			exit;
		}
		route(BALANCE);
		$avp(fr_timer) = 3;
		route(RELAY);
	}
	
	if (is_method("MESSAGE")) {
		if ($var(from_proxy) == 1) {
			# Topology hiding
			remove_hf("Authorization");					#Удалить заголовок
			remove_hf("Proxy-Authorization");
			$du = $ru;									#подмена полей
			$rd = $fd;
		} else {										#если это входящиее сообщение
			append_hf("x-src-uri: sip:$si:$sp;transport=$protorn");		
			route(BALANCE);
		}
		route(RELAY);
	}
	
	if (is_method("ACK")) 
	{
		exit; 							# Must be an ACK after 401
	}	
	if (is_method("SUBSCRIBE|PUBLISH")) {
		xlog("L_ERR", "[MAIN] Method not supported (M=$rm IP=$si:$sp RURI=$ru DURI=$du F=$fu T=$tu oP=$oP pr=$pr dP=$dP rP=$rP ID=$ci cseq=$cs UA=$ua)n");
		send_reply("501", "Method not supported here");
		exit;
	}
	if (!is_method("INVITE|OPTIONS")) {
		xlog("L_ERR", "[MAIN] Call leg/Transaction does not exist (M=$rm IP=$si:$sp RURI=$ru DURI=$du F=$fu T=$tu oP=$oP pr=$pr dP=$dP rP=$rP ID=$ci cseq=$cs UA=$ua)n");
		send_reply("481", "Call leg/Transaction does not exist");
		exit;
	}
}	
